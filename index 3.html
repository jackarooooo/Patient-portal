<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .data-row > div:first-child { font-weight: 600; color: #374151; }
        .data-row > div:last-child { color: #1f2937; }
        input[type="text"], textarea {
            border: 1px solid #d1d5db;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9fafb;
        }
        .mode-toggle {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to Debug
        setLogLevel('debug');

        // --- GLOBAL CANVAS VARIABLES (Mandatory to use) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let isAuthReady = false;
        // Determine if the current user is the app creator (only creators have the initialAuthToken)
        const isEditor = !!initialAuthToken; 
        
        // Use a URL parameter for initial public vs. editor view
        const urlParams = new URLSearchParams(window.location.search);
        let currentMode = urlParams.get('mode') === 'preview' ? 'preview' : 'editor'; 
        
        // Ensure that if a non-editor hits the page, they only see preview mode
        if (!isEditor) {
            currentMode = 'preview';
        }

        // Firestore paths
        const PUBLIC_DATA_PATH = `/artifacts/${appId}/public/data/appointmentData/mainDocument`;

        // Default data structure
        const defaultData = {
            patientId: '776538F',
            name: 'Md Amin Uddin',
            gender: 'MALE',
            age: '63',
            invoiceNo: 'W3837210',
            billNo: 'A003206314',
            receiptNo: 'MOBAPR143434',
            appointmentType: 'General',
            doctorName: 'General Doctor',
            clinicName: 'VASCULAR SURGERY -RANIPET',
            appointmentDate: '15/11/2025',
            reportingTime: '07:30 AM',
            reportingLocation: "HELP DESK, A BLOCK - GROUND FLOOR\nRANIPET CAMPUS, KILMINNAL VILLAGE, RANIPET\nDISTRICT - 632517, TAMIL NADU.",
            modeOfPayment: 'NET BANKING RECEIPT',
            paidOn: '05/11/2025 04:46 PM',
            amount: 'Rs.130/-',
            additionalNote: 'Please report to MEDICAL RECORDS OFFICER prior to your Appointment Time.'
        };

        const appointmentData = { ...defaultData };

        // DOM elements
        const contentEl = document.getElementById('main-content');
        const loaderEl = document.getElementById('loader');

        // --- Firebase Initialization and Authentication ---
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // If editor, ensure default data is saved once
                        if (isEditor) {
                            const docRef = doc(db, PUBLIC_DATA_PATH);
                            const docSnap = await getDoc(docRef);
                            if (!docSnap.exists()) {
                                console.log("Initializing data...");
                                await setDoc(docRef, defaultData);
                            }
                        }
                    } else {
                        await signInAnonymously(auth);
                        return;
                    }
                    isAuthReady = true;
                    setupDataListener();
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization or Sign-in Error:", error);
                renderApp(defaultData);
                loaderEl.classList.add('hidden');
            }
        };

        // --- Data Listener ---
        const setupDataListener = () => {
            const docRef = doc(db, PUBLIC_DATA_PATH);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && isAuthReady) {
                    const latestData = docSnap.data();
                    Object.assign(appointmentData, latestData);
                } else if (isAuthReady) {
                    Object.assign(appointmentData, defaultData);
                }
                
                renderApp(appointmentData);
                loaderEl.classList.add('hidden');
                
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
            });
        };

        // --- Mode Toggle Function ---
        window.toggleMode = (mode) => {
            currentMode = mode;
            
            // Generate the clean public URL for the alert
            const publicUrl = window.location.href.split('?')[0] + '?mode=preview'; 

            if (mode === 'preview') {
                alert("You are now viewing the *Preview Portal*. This is the URL you should use to generate the QR code:\n\n" + publicUrl);
            }
            // Simply re-render the app based on the new mode
            renderApp(appointmentData);
        };

        // --- Main Renderer ---
        const renderApp = (data) => {
            if (currentMode === 'editor' && isEditor) {
                renderEditor(data);
            } else {
                // Anyone who is not the editor, or the editor in preview mode, sees the viewer
                renderViewer(data);
            }
        }


        // --- Data Fields definition ---
        const fields = [
            { id: 'patientId', label: 'Patient ID', section: 'header' },
            { id: 'name', label: 'Name', section: 'header' },
            { id: 'gender', label: 'Gender', section: 'header' },
            { id: 'age', label: 'Age', section: 'header' },
            
            { id: 'invoiceNo', label: 'Invoice No', section: 'details' },
            { id: 'billNo', label: 'Bill No', section: 'details' },
            { id: 'receiptNo', label: 'Receipt No', section: 'details' },
            { id: 'appointmentType', label: 'Appointment Type', section: 'details' },
            { id: 'doctorName', label: 'Doctor Name', section: 'details' },
            { id: 'clinicName', label: 'Clinic Name', section: 'details' },
            { id: 'appointmentDate', label: 'Appointment Date', section: 'details' },
            { id: 'reportingTime', label: 'Reporting Time', section: 'details', time: true },
            
            { id: 'reportingLocation', label: 'Reporting Location', section: 'location', textarea: true },

            { id: 'modeOfPayment', label: 'Mode of Payment', section: 'payment' },
            { id: 'paidOn', label: 'Paid On', section: 'payment' },
            { id: 'amount', label: 'Amount', section: 'payment' },
            
            { id: 'additionalNote', label: 'Note', section: 'footer', textarea: true }
        ];

        // --- Viewer Mode Rendering (The "Legit" Slip) ---
        const renderViewer = (data) => {
            const getRow = (label, value, isHighlighted = false) => `
                <div class="data-row grid grid-cols-2 p-2 border-b border-gray-200">
                    <div class="${isHighlighted ? 'text-yellow-700' : ''}">${label}</div>
                    <div class="text-right ${isHighlighted ? 'font-bold text-yellow-900' : ''}">${value.replace(/\n/g, '<br>')}</div>
                </div>
            `;

            // HTML for the Editor Toggle Button (Only visible to the editor)
            const toggleButton = isEditor ? `
                <button onclick="toggleMode('editor')" class="mode-toggle bg-yellow-500 hover:bg-yellow-600 text-white shadow-md">
                    Switch to Editor
                </button>` : '';

            // The main HTML structure mimicking the screenshot
            contentEl.innerHTML = `
                <div class="max-w-xl mx-auto bg-white min-h-screen shadow-lg">
                    <!-- Top Bar -->
                    <div class="bg-yellow-600 text-white p-3 flex justify-between items-center sticky top-0 z-10">
                        <div class="text-lg font-semibold">CMC Patient Portal</div>
                        <div class="flex items-center space-x-2">
                           ${toggleButton}
                           <button class="text-white text-2xl" onclick="window.location.reload();">☰</button>
                        </div>
                    </div>

                    <!-- Header Data -->
                    <div class="p-3 text-sm space-y-1 bg-gray-50 border-b border-gray-200">
                        ${getRow('Patient ID', data.patientId)}
                        <div class="text-lg font-bold">${data.name}</div>
                        <div class="text-sm text-gray-600">${data.gender} | Age: ${data.age}</div>
                    </div>

                    <!-- Validation Bar -->
                    <div class="bg-green-700 text-white text-center p-3 font-bold text-lg rounded-t-lg mt-4">
                        Appointment Successfully Validated.
                    </div>

                    <!-- Details Table -->
                    <div class="p-4 bg-gray-100 border-b border-gray-300">
                        <div class="space-y-1 bg-white border border-gray-300 rounded overflow-hidden shadow-md">
                            ${getRow('Invoice No', data.invoiceNo)}
                            ${getRow('Bill No', data.billNo)}
                            ${getRow('Receipt No', data.receiptNo)}
                            ${getRow('Appointment Type', data.appointmentType)}
                            ${getRow('Doctor Name', data.doctorName)}
                            <div class="data-row grid grid-cols-2 p-2 bg-gray-300">
                                <div>Clinic Name</div>
                                <div class="text-right font-bold">${data.clinicName}</div>
                            </div>
                            <div class="data-row grid grid-cols-2 p-2 bg-yellow-300">
                                <div>Appointment Date</div>
                                <div class="text-right font-bold">${data.appointmentDate}</div>
                            </div>
                            ${getRow('Reporting Time - Report to MRO at', data.reportingTime)}
                        </div>
                    </div>
                    
                    <!-- Reporting Location -->
                    <div class="p-4 bg-white border-b border-gray-300 text-center">
                        <div class="font-bold mb-2">HELP DESK, A BLOCK - GROUND FLOOR</div>
                        <div class="text-sm whitespace-pre-wrap">${data.reportingLocation.replace('HELP DESK, A BLOCK - GROUND FLOOR\n', '')}</div>
                    </div>

                    <!-- Payment Details -->
                    <div class="p-4 bg-gray-100">
                        <div class="space-y-1 bg-white border border-gray-300 rounded overflow-hidden shadow-md">
                            <div class="data-row grid grid-cols-2 p-2 bg-gray-300">
                                <div>Mode of Payment</div>
                                <div class="text-right font-bold">${data.modeOfPayment}</div>
                            </div>
                            ${getRow('Paid On', data.paidOn)}
                            <div class="data-row grid grid-cols-2 p-2 bg-yellow-100 font-bold text-lg">
                                <div>Amount</div>
                                <div class="text-right text-red-700">${data.amount}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Note -->
                    <div class="p-4 text-center text-red-800 bg-red-100 border-t border-red-300">
                         ${data.additionalNote}
                    </div>

                    <!-- Footer -->
                    <div class="text-center text-xs p-4 bg-gray-800 text-gray-400">
                        © 2018. All rights reserved. <a href="#" class="text-yellow-500">CMC Vellore.</a>
                    </div>
                </div>
            `;
        };

        // --- Editor Mode Rendering (Input Fields) ---
        const renderEditor = (data) => {
            // HTML for the Preview Toggle Button
            const toggleButton = `
                <button onclick="toggleMode('preview')" class="mode-toggle bg-blue-600 hover:bg-blue-700 text-white shadow-md">
                    Switch to Preview Mode
                </button>`;

            const formHTML = fields.map(field => {
                const value = data[field.id] || '';
                let inputElement;

                if (field.textarea) {
                    inputElement = `<textarea id="edit-${field.id}" rows="${field.id === 'reportingLocation' ? 4 : 2}" class="text-sm">${value}</textarea>`;
                } else {
                    inputElement = `<input type="text" id="edit-${field.id}" value="${value}" class="text-sm">`;
                }

                return `
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-200">
                        <label for="edit-${field.id}" class="block text-xs font-medium text-gray-700 uppercase mb-1">${field.label}</label>
                        ${inputElement}
                    </div>
                `;
            }).join('');

            contentEl.innerHTML = `
                <div class="max-w-xl mx-auto p-4 bg-white rounded-lg shadow-2xl mt-4">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h1 class="text-2xl font-bold text-yellow-600">Appointment Details Editor</h1>
                        ${toggleButton}
                    </div>
                    <p class="text-sm text-gray-600 mb-4">You are in **Editor Mode**. Change the details below and click **Save** to update the public portal.</p>
                    <form id="editor-form">
                        ${formHTML}
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md mt-4">
                            Save & Update Portal
                        </button>
                    </form>
                    <div class="mt-4 p-3 bg-blue-100 text-blue-700 border border-blue-300 rounded-lg text-xs">
                        **Action:** Click 'Switch to Preview Mode' to see the final, legitimate-looking slip.
                    </div>
                </div>
            `;

            // Setup form submission listener
            document.getElementById('editor-form').addEventListener('submit', handleSave);
        };

        // --- Save Functionality ---
        const handleSave = async (event) => {
            event.preventDefault();
            
            const newData = {};
            let isChanged = false;

            fields.forEach(field => {
                const input = document.getElementById(`edit-${field.id}`);
                if (input) {
                    const newValue = input.value;
                    newData[field.id] = newValue;
                    if (appointmentData[field.id] !== newValue) {
                        isChanged = true;
                    }
                }
            });

            if (!isChanged) {
                 alert('No changes detected. Data not saved.');
                 return;
            }

            if (!db) {
                console.error("Firestore not initialized.");
                 alert('Error: Database not ready.');
                 return;
            }

            const saveButton = event.target.querySelector('button[type="submit"]');
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;

            try {
                const docRef = doc(db, PUBLIC_DATA_PATH);
                await setDoc(docRef, newData);
                
                // Saving successful, toggle to preview mode
                saveButton.textContent = 'Saved!';
                setTimeout(() => {
                    saveButton.textContent = 'Save & Update Portal';
                    saveButton.disabled = false;
                    toggleMode('preview');
                }, 1000); 

            } catch (error) {
                console.error("Error saving document:", error);
                saveButton.textContent = 'Error Saving!';
                saveButton.disabled = false;
                 alert('An error occurred during save. Check console for details.');
            }
        };

        // --- Initial Load ---
        window.onload = initFirebase;
    </script>
</head>
<body>
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="text-xl text-gray-700 flex items-center space-x-2">
            <svg class="animate-spin h-5 w-5 text-yellow-600" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Loading Portal...</span>
        </div>
    </div>
    
    <!-- Main content container where either editor or viewer is rendered -->
    <div id="main-content">
        <!-- Content inserted by renderApp function -->
    </div>

    <!-- Custom Modal for Alerts (replacing alert()) -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold mb-3 text-red-600">Error/Info</h3>
            <p id="custom-alert-message" class="text-gray-700"></p>
            <button onclick="document.getElementById('custom-alert-modal').classList.add('hidden');" class="mt-4 w-full bg-yellow-600 text-white py-2 rounded-md hover:bg-yellow-700">OK</button>
        </div>
    </div>
    <script>
        // Override alert function for a custom UI modal
        window.alert = function(message) {
            const modal = document.getElementById('custom-alert-modal');
            document.getElementById('custom-alert-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };
    </script>
</body>
</html>

